<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">

<meta name="ICBM" content="19.0760, 72.8777">
<meta name="geo.position" content="19.0760;72.8777">
<meta name="geo.region" content="IN-MH">
<meta name="geo.placename" content="Mumbai">
<title>[project] 2019 年电子设计竞赛：模拟电磁曲射炮设计 | xym-ee</title>


        <link rel="stylesheet" href="/css/tailwind.min.ce97201a436e89554f6444624e62d4b32a48d70d124d557a1852401701ab43bc.css" type="text/css" integrity="sha256-zpcgGkNuiVVPZERiTmLUsypI1w0STVV6GFJAFwGrQ7w=" crossorigin="anonymous">

</head>

<body class="bg-gradient-to-r from-slate-900 to-slate-800 font-mono text-white">
  <div class="container mx-auto flex flex-col px-4 xl:w-8/12 sm:max-w-full">
    
  

  <header class="flex flex-row py-4" >

  



  <nav
    class="flex flex-row items-center w-full justify-between">


  
  
    <div class="flex flex-col gap-1">
      <a href="https://xym.work/" class="text-4xl font-bold hover:text-sky-400 whitespace-nowrap">xym-ee</a>
      <p>Embedded Systems & Robot Control</p>
    </div>
  

  <div class="dropdown-menu flex flex-row absolute max-lg:w-full max-lg:items-center max-lg:justify-center max-lg:-top-full lg:static max-lg:bg-slate-900 max-lg:h-[calc(100dvh)] max-lg:left-0">
    <ul class="flex flex-col lg:flex-row gap-2">
      
  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/about.html">About</a>
  </li>

  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/gallery.html">Gallery</a>
  </li>

  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/blog">Blog</a>
  </li>

  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/notebook.html">Notebook</a>
  </li>

    </ul>
  </div>
  <div class="open-dropdown-button lg:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="32" height="32" fill="white">
      <path
        d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z" />
    </svg>
  </div>
  <div class="close-dropdown-button hidden z-50">
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 384 512" width="32" height="32" fill="white">
      <path
        d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z" />
    </svg>
  </div>
</nav>
</header>

  
  <div class="flex flex-col pt-8 gap-10">
    
    <div class="flex flex-col w-full gap-4">
      <h2 class="text-3xl max-sm:text-2xl font-bold">[project] 2019 年电子设计竞赛：模拟电磁曲射炮设计</h2>
      
      <div class="flex flex-row flex-wrap max-md:gap-4 gap-10">
        <p>📅 2024-08-30</p>
        
          <p>🔄 2024-08-30</p>
        
        <p>⌚ Reading time: 1 min</p>
      </div>
      
      <div class="flex flex-row gap-2 flex-nowrap">
        <p class="py-1">🏷️</p>
<div class="flex flex-wrap gap-2">
  
    <a href='/tags/project'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">project</a>
  
    <a href='/tags/rt-thread'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">rt-thread</a>
  
    <a href='/tags/stm32'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">stm32</a>
  
    <a href='/tags/%E7%94%B5%E5%AD%90%E8%AE%BE%E8%AE%A1%E7%AB%9E%E8%B5%9B'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">电子设计竞赛</a>
  
</div>
      </div>
      <hr />
      <div class="flex flex-col gap-10">
        <div class="prose prose-invert max-w-full">
          <ul>
<li><a href="https://github.com/xym-ee/electromagnetic-railgun">源码仓库</a></li>
</ul>
<h1 id="0简介">0.简介</h1>
<p>我参加了 2019 年全国大学生电子设计竞赛，当时我大三。选的题目是模拟电池曲射炮设计。赛题要求是设计制作一个电磁炮模型，通过视觉识别指定元素，自动发射射击。</p>
<p>电磁炮与环形靶的位置示意如图所示。电磁炮放置在定标点处，炮管初始水平方向与中轴线夹角为 $ 0 \degree $ 、垂直方向仰角为 $ 0 \degree $ 。环形靶水平放置在地面，靶心位置在与定标点距离 $ 200 \text{cm} \le  d \le 300 \text{cm} $ ，与中心轴线夹角 $ \alpha \le \pm 30 \degree $ 的范围内。</p>
<img src="./images/curved-fire-gun-1.png" width="500" style="display: block; margin: auto;">
<p>需要实现的功能</p>
<ul>
<li>炮弹的发射和命中功能
<ul>
<li>最基本的发射功能</li>
<li>对发射距离的控制</li>
</ul>
</li>
<li>有视觉检测功能</li>
<li>炮管左右运动的功能</li>
</ul>
<p>这个东西应该是硬件设计的内容占了60%，需要设计出合适的发射装置，使得可以通过  MCU 控制发射距离。视觉检测目标然后和转动到目标角度都要在能成功发射并命中的前提下才有意义。</p>
<p>先看当时实现的参赛作品</p>
<img src="./images/curved-fire-gun-6.png" width="300" style="display: block; margin: auto;">
<p>精度控制效果</p>
<img src="./images/curved-fire-gun-1.gif" width="300" style="display: block; margin: auto;">
<p>精度还是不错的，拿了江苏省一等奖，实际上我们已经进入全国总测评了，如果总测评过了就是全国一等奖，没过是国二。但是呢，作品可能在路上出问题了，然后就退回省一了😂。还是比较可惜的，好在学校的比赛出问题都是小问题，如果这是工作上的失误那可能要出大问题。</p>
<p>23 年，有人觉得这个东西挺好玩的，是一个不错的教学用具，然后我在比赛的基础上，重新基于 RTOS 写了代码，并且做的更细致了一些。</p>
<h2 id="12019电赛版电磁炮的设计思路">1.2019电赛版电磁炮的设计思路</h2>
<p>实现赛题要求需要 3 部分，充能与发射装置、云台、视觉检测，当时主控芯片选的是 NXP imx rt1052，此外还有显示屏、按键等完成交互操作。和电机控制类似，这也是个典型的低压控制高压的电子系统。整体上的设计如图所示</p>
<img src="./images/curved-fire-gun-4.png" width="300" style="display: block; margin: auto;">
<p>先考虑充能和发射装置，发射的基本原理：电感线圈流过电流时产生一个磁场，用磁场对磁性炮弹有一个作用力，完成对炮弹的发射。</p>
<p>这个感生磁场还不能一直存在，否则前段加速炮弹，后段会阻碍炮弹。也就是说线圈要通过瞬间的大电流，因此就需要大容量的电容来对线圈放电，刚好能实现比较好的发射效果。此外还需要配套的充电装置和放电开关，还需要实时检测电容充电电压以控制电容中的储能量，这是对炮弹发射距离控制的关键。</p>
<p>由于比赛时使用的是锂电池供电，因此为了能给电容充电到一个比较高的电压，需要逆变器和整流器，对于充电通断的控制可以使用继电器来实现。电容电压检测则需要使用分压电阻分压然后做隔离送入 MCU 的 ADC 端口。电容对发射线圈的放电开关需要使用晶闸管，使用继电器的话触点常容易损坏。</p>
<p>因此高压部分的原理上为下面这个图</p>
<img src="./images/curved-fire-gun-5.png" width="500" style="display: block; margin: auto;">
<p>细节上的实现</p>
<img src="./images/curved-fire-gun-2.png" width="600" style="display: block; margin: auto;">
<p>把发射模块看做一个整体，有这些输入输出引脚输出接口</p>
<ul>
<li>GPIO_IN, 充电控制</li>
<li>GPIO_IN, 发射控制</li>
<li>AD_OUT, 充电电压反馈</li>
</ul>
<p>云台使用舵机云台就可以，这个任务里 openmv 就可以胜任识别的工作，openmv 和控制板使用串口通信，openmv 只需要发送回目标的横坐标即可。</p>
<p>当时的代码是裸机开发实现的，代码也没做备份现在也找不到了😂。</p>
<h2 id="2教具版电磁炮的设计思路">2.教具版电磁炮的设计思路</h2>
<p>发射部分、视觉识别部分、云台部分还是和以前一样，但是主控换成了 STM32，并且使用 rt-thread 来完成所有功能的开发，在交互功能上做了新的改进。</p>
<p>先来看效果</p>
<video controls width="480">
  <source src="./videos/curved-fire-gun-1.mp4" type="video/mp4">
</video>
<p>考虑到这是教学用具，设计这些功能</p>
<ul>
<li>有两种模式：手动控制模式和自动追踪目标模式</li>
<li>手动控制模式使用按键调整炮管的指向</li>
<li>自动追踪模式下炮管自动指向目标</li>
<li>出于安全考虑不论是手动模式还是自动模式，都需要手动控制电容充电和发射</li>
<li>需要设计充满电自动停止充电的功能，并且需要使用蜂鸣器提示电容有点</li>
</ul>
<p>因此这一版电磁炮使用了更多的控制按键，这就需要考虑按键的读取逻辑和按键处理事件这两个事情。比较复杂的系统，按键的读取与事件处理可以分离开来考虑，以提高代码的可维护性和扩展性。</p>
<p>rtt 提供了许多按键相关的软件包。使用事件驱动型按键驱动模块，将按键处理函数和按键及按键状态分开，去掉了按键处理的硬编码，使得业务逻辑更清晰。</p>
<p>比如控制云台转动的其中一个按键，定义按键，实现按键值读取函数和按键发生时要做的事情。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Button_t btn_servo_l;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint8_t</span> <span style="color:#a6e22e">read_btn_servo_l</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rt_pin_read</span>(SERVO_L_PIN);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">btn_servo_l_down_cb</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>btn)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    status.pts_control <span style="color:#f92672">=</span> LEFT;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rt_kprintf</span>(<span style="color:#e6db74">&#34;SERVO_L_PIN once press</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后在初始化时，绑定按键和事件触发的回调函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">Button_Create</span>(<span style="color:#e6db74">&#34;btn_servo_l&#34;</span>, <span style="color:#f92672">&amp;</span>btn_servo_l, read_btn_servo_l, PIN_LOW);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Button_Attach</span>(<span style="color:#f92672">&amp;</span>btn_servo_l, BUTTON_DOWM, btn_servo_l_down_cb);
</span></span></code></pre></div><p>然后开一个线程调用按键库作者提供的按键处理函数即可。用户只需要思考按键按下以后，有什么事情要发生即可。</p>
<h2 id="3总结">3.总结</h2>
<p>这已经是我时隔多年总结以前的项目，这个项目是我刚使用 rt-thread 比较熟练的时候做的，但是现在会看以前的代码，其实还是有很多问题。</p>
<p>比如按键逻辑的那一块，即使使用了按键库，我还是定义了一个 <code>int key=0</code> ，在按键回调函数中修改了这个值，现在已经看不懂为什么要改值了，拿我现在对自己的标准来说，这个代码没有做到不言自明，用数字代表状态本来就增加了阅读代码的障碍，这使得用了按键库也并没有比没用让代码更好读。</p>
<p>如果现在让我实现这个代码的话，我大概率会直接在按键回调函数中去修改云台对应方向的转角值。因为操作的逻辑就是按下左键，云台左移，那么回调函数里就直接做左移的动作。这样的代码应该才是<strong>不言自明</strong>的。完全把操作逻辑和代码逻辑就对应起来了。</p>

          <hr />
        </div>
        <div>
          

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
    this.page.url = "https:\/\/xym.work\/blog\/curved-fire-gun.html";
    this.page.identifier = ""; 
    };
    (function () { 
      var d = document, s = d.createElement('script');
      s.src = 'https://xym.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>


        </div>
      </div>
    </div>

    <div class="footer flex items-center justify-center">
  <div class="py-4">
  <footer>
    <p class="whitespace-nowrap">© 2024. <a href="https://github.com/xym-ee" target="_blank">xym-ee
    </a> all rights reserved.</p>
  </footer>
</div>
</div>
  </div>
  

  </div>
  
        <script type="text/javascript" src="/js/navbar.min.a2e7a3db4f1b58e7616cfd31a099340a207d5b99d96df87f525f17c604e184c1.js" integrity="sha256-ouej208bWOdhbP0xoJk0CiB9W5nZbfh/Ul8XxgThhME=" crossorigin="anonymous"></script>

  <script id="dsq-count-scr" src="//nayanseth.disqus.com/count.js" async></script>
  <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$']],  
      displayMath: [['$$', '$$']]  
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    document.addEventListener('DOMContentLoaded', function() {
      const icon1 = document.getElementById('svgwechat');
      const tooltip1 = document.getElementById('wechattip');

      icon1.addEventListener('mouseenter', function(event) {
        const rect = icon1.getBoundingClientRect();

        
        tooltip1.style.left = `${rect.left + window.scrollX - 100}px`;
        tooltip1.style.top = `${rect.bottom + window.scrollY + 20}px`;

        tooltip1.style.display = 'block';
      });

      icon1.addEventListener('mouseleave', function() {
        tooltip1.style.display = 'none';
      });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const icon2 = document.getElementById('svgqq');
      const tooltip2 = document.getElementById('qqtip');

      icon2.addEventListener('mouseenter', function(event) {
        const rect = icon2.getBoundingClientRect();

        
        tooltip2.style.left = `${rect.left + window.scrollX -100 }px`;
        tooltip2.style.top = `${rect.bottom + window.scrollY + 20}px`;

        tooltip2.style.display = 'block';
      });

      icon2.addEventListener('mouseleave', function() {
        tooltip2.style.display = 'none';
      });
    });
</script>

</body>

</html>